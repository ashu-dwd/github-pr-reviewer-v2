name: AI PR Reviewer

on:
  # trigger on new PRs and updates
  pull_request:
    types: [opened, synchronize]

  # trigger on /review command in PR comments
  issue_comment:
    types: [created]

# granting write permission so the bot can post comments on PRs
permissions:
  pull-requests: write
  contents: read

jobs:
  review:
    runs-on: ubuntu-latest
    # only run if:
    # 1. it's a pull_request event, OR
    # 2. it's an issue_comment on a PR with "/review" command
    if: |
      github.event_name == 'pull_request' ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '/review'))

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install -r requirements.txt

      # acknowledging the /review command with a reaction
      - name: Add reaction to comment
        if: github.event_name == 'issue_comment'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'eyes'
            });

      # getting PR URL for issue_comment events (need to fetch it from the API)
      - name: Get PR URL
        id: get_pr_url
        uses: actions/github-script@v7
        with:
          script: |
            let prUrl;
            if (context.eventName === 'pull_request') {
              prUrl = context.payload.pull_request.html_url;
            } else if (context.eventName === 'issue_comment') {
              // fetching PR details from the issue
              const pr = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.issue.number
              });
              prUrl = pr.data.html_url;
            }
            core.setOutput('pr_url', prUrl);
            console.log(`PR URL: ${prUrl}`);

      - name: Run AI Review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        working-directory: ${{ github.workspace }}
        run: python src/main.py "${{ steps.get_pr_url.outputs.pr_url }}"

      # adding success reaction after review is posted
      - name: Add success reaction
        if: github.event_name == 'issue_comment' && success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });
